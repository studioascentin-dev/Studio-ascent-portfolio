/**
 * @file Firebase Security Rules for Firestore (Prototyping Mode)
 *
 * @core_philosophy This ruleset prioritizes security by strictly controlling write access to all collections.
 *  Read access is generally public, but write access is heavily restricted. All `create`, `update`, and `delete`
 *  operations require authentication and often additional checks. This approach favors rapid iteration
 *  by allowing flexible data shapes while enforcing a secure authorization model.
 *
 * @data_structure The database consists of four top-level collections: `projects`, `categories`, `contacts`, and
 *  `supportRequests`. Each collection stores documents representing the corresponding entity.
 *
 * @key_security_decisions
 *  - Public Read Access: `projects` and `categories` are publicly readable, allowing anyone to retrieve project and category data.
 *  - Protected Write Access: All write operations (`create`, `update`, `delete`) are protected, requiring authentication.
 *  - Contact and Support Request Handling: `contacts` and `supportRequests` are only writable by authenticated users, likely to prevent abuse.
 *  - No User Listing: User listing is not supported.
 *
 * @denormalization_for_authorization Not applicable. The current design does not require denormalization for authorization,
 *  as no complex ownership or role-based access control is defined.
 *
 * @structural_segregation The top-level collections represent structural segregation.  Each entity type has its own collection,
 *  simplifying security rules and queries.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants public read access to projects, while restricting write access to authenticated users.
     * @path /projects/{projectId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn();
     * @allow update: if isSignedIn() && resource != null;
     * @allow delete: if isSignedIn() && resource != null;
     * @deny create: if !isSignedIn();
     * @deny update: if !isSignedIn();
     * @deny delete: if !isSignedIn();
     * @principle Allows public access to projects while ensuring only authenticated users can modify them.
     */
    match /projects/{projectId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Grants public read access to categories, while restricting write access to authenticated users.
     * @path /categories/{categoryId}
     * @allow get, list: if true;
     * @allow create: if isSignedIn();
     * @allow update: if isSignedIn() && resource != null;
     * @allow delete: if isSignedIn() && resource != null;
     * @deny create: if !isSignedIn();
     * @deny update: if !isSignedIn();
     * @deny delete: if !isSignedIn();
     * @principle Allows public access to categories while ensuring only authenticated users can modify them.
     */
    match /categories/{categoryId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Restricts write access to contacts to authenticated users only.
     * @path /contacts/{contactId}
     * @allow get, list: if false;
     * @allow create: if isSignedIn();
     * @allow update: if false;
     * @allow delete: if false;
     * @deny get, list: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Ensures that only authenticated users can submit contact forms, preventing anonymous spam.
     */
    match /contacts/{contactId} {
      allow get, list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Restricts write access to support requests to authenticated users only.
     * @path /supportRequests/{supportRequestId}
     * @allow get, list: if false;
     * @allow create: if isSignedIn();
     * @allow update: if false;
     * @allow delete: if false;
     * @deny get, list: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Ensures that only authenticated users can submit support requests, preventing anonymous spam.
     */
    match /supportRequests/{supportRequestId} {
      allow get, list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    // Helper function to determine if a user is signed in
    function isSignedIn() {
      return request.auth != null;
    }
  }
}